<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<title>Mesurador de dist√†ncies avan√ßat</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; margin-top: 10px; width: 100%; }
  /*Border-collapse el que fa √©s la doble l√≠nia per defecte en tota la taula covertir-la, colapsar-la */
  th, td { border: 1px solid #ccc; padding: 5px 10px; text-align: center; }
  /*El border √©s la cantonada que veiem i el que hi ha forma es diu margin i el marge que hi ha per dintre √©s el padding*/
  input, button { padding: 6px; font-size: 14px; margin: 2px; }
  #estat { margin-top: 10px; font-style: italic; color: #555; }
  #map { height: 300px; margin-top: 10px; border: 1px solid #ccc; }
</style>
</head>
<body>

<h2>Mesurador de Latitud i Longitud Avan√ßat</h2>

<label><b>Indica el lloc:</b></label>
  <!--Es una etiqueta per escriure que acompanya a un textbox o caixa de text o definida per un input.
  L'input de m√©s a baix no accepta numbers nom√©s accepta text i t√© un text per defecte definit per la propietat placeholder.-->
<input id="ubicacioInput" type="text" placeholder="Ex: Punt A">
  <!--A continuaci√≥ tenim tres botons que quan els cliquem s'executan les funcions de la l√≠nia function mesura(){instuccions...}
  i els altres dos botons cridran les funcions de javascript gr√†cies a la propietat o atribut onclick
  CSV significa comma separated values o valors separats per coma i √©s la forma m√©s f√†cil de guardar dades per exemple 
  latitud, longitud 
  41.2,2.1
  41.3,2.2
  El he escrit m√©s amunt √©s un csv i √©s compatible amb excel o llibreofice calc o qualsevol programa de dades o taules
  Creem un funci√≥ anomenada function exportCSV(){instuccions que guarden les dades de latitu i longitud}
  Gpx significa GPs eXchange forma √©s un fitxer tipus XML que serveix per emmagatzemar i intercanviar dades gps
  Xml √©s molt potent perqu√® √©s extensible a qualsevol etiqueta que m'invento per exemple <brandcar>Seat</brandcar>
  El gpx t√© unes etiquetes propies, la primera √©s <trk> que es genera dintre de la function exportGPX ()
  Trk significa tracks o trajectes que s√≥n registres de camins o rutes seguits formats per una serie de punts (latitud, longitut ordenats 
  cronologicament)
    Dintre del trk hi ha una etiqueta <name> que hi ha el nom de la ruta, i a continuaci√≥n hi ha una etiqueta trkpt, abans hi ha un trkseg
      que es una secuencia de trkpt o track points que a vegades s'anomenen waypoints o punts de referencia, cada track point t√© una latitud i una longitud
  per exemple <trkpt lat="41.842" lon="1.936"></trkpt>
  Podem afegir m√©s etiquetes  com per exemple <ele> que significa elevaci√≥ que √©s l'al√ßada en mettres del punt
  GPX √©s u ormat obert, √©s a dir, que no hi ha cap empresa propietaria i es un format molt utilitzat per dispositius gps, per 
  programes que utilitzen mapes digitals o per apps que utilitzen rutes. √âs compatibles amb gis que son sistemes d'informaaci√≥ geogr√†fica.
  
  -->
<button onclick="mesura()">Mesura</button>
<button onclick="exportCSV()">Exporta CSV</button>
<button onclick="exportGPX()">Exporta GPX</button>
<div id="estat"></div>

<table id="mesuresTable">
  <tr>
    <th>#</th>
    <th>Latitud</th>
    <th>Longitud</th>
    <th>Ubicaci√≥</th>
  </tr>
</table>

<h3>Dist√†ncies pas a pas</h3>
<div id="distancies"></div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- La l√≠nia 66 carrega leaflet.js i fa possible que funcionin els mapes. Leaflet √©s una biblioteca javascript de codi obert. Tothom t√© acc√©s
  i pot veure internament el codi.
Per exeple google maps no √©s un codi obert, pertany a google, √©s codi tancat o codi propietari que no nom√©s no puc veure
  toot sin√≥ que tampoc el puc modificar (similar a libreoffice(√©s gratis i de ci obert i inclou editor de text o editor de diapositives
  o editor dde full de c√†lculs que es diu calc, en canvi en micrsoft office, concretament word.
  Leaflet fa mapes interactius compatibles amb el m√≤bil.-->
<script>
  /*let mesures ssignifica crear una variable global perqu√® afecta a tot l'scriipt que comen√ßa a la l√≠nia 73 i la iniciallitzem amb un conjunt 
  de valors [] qu es coneix com array buit amb l'intenci√≥ d'emmagatzemar lectures gps de latitut i longitut.
  let map crea una inst√†ncia de maapa tipus leaflet i l'assigna a un element, al que tingui una id anomenada maap que en aquest cas es un divisor o  est√† 
  a la l√≠nia 63 i que es el lloc on apareixer√† el mapa. Si no hi hagu√©s escritla l√≠nia 63, la 81 generaria un error ja que no trobaria un lloc on posar el mapa.
  El setView dona una visita inicial del mapa i  les coordenades inicials son 0,0 que est√† situat en el Golf de Guinea i 2 √©s el zoom, que √©s molt allunyat. Quan m√©s ampliem m√©s coses 
  m√©s espec√≠fiques veurem.*/
let mesures = [];
let map = L.map('map').setView([0,0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  /*L.tileLayer, tile sigifica mosaic per tant √©s una capa                */
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);
  /* addTo(map) */
let polyline = L.polyline([], {color:'red'}).addTo(map);
/*Polyline */
function mesura() {
  /*function mesura*/
  const estat = document.getElementById("estat");
  /*Variable definida com a constant √©s una variable per√≤ que t√© molt pocs vaalors constants */
  estat.textContent = "üîç Obtenint GPS amb precisi√≥ alta...";

  if (!navigator.geolocation) {
    /* ! (VOL DIR NEGACI√ì) */
    alert("La geolocalitzaci√≥ no √©s compatible amb aquest navegador.");
    return;
  }
  /*getCurrentPosition = part de l'API de Geolocation, pot funcionar amb un √∫nic argument (posici√≥) per√≤ pot contenir fins a 3.
   Primer argument [(pos)] = CallBack d'√®xit, funci√≥ an√≤nima executada quan el navegador obt√© la posici√≥. Nom√©s rep un objecte anomenat "pos".
   Segon argument [(err)] = CallBack d'error, funci√≥ an√≤nima executada quan el navegador no obt√© la posici√≥.
   Tercer argument = Objecte d'opcions, permet regular com funciona el gps.
   La funci√≥ "=>" situada darrere de "(pos)" √©s la funci√≥ an√≤nima perqu√® no s'escriu la paraula "function".
   "(pos)" t√© uns arguments que s√≥n "coords.latitude" i "coords.longitude", emmagatzemats a les constants "lat" i "lon" respectivament.
   41,38 per latitud i 2,18 per longitud. S√≥n variables num√®riques (floating point numbers).
   La constant "ubicacio" agafa amb la funci√≥ "getElementById" el valor de la l√≠nia 23, introduit per l'usuari. √âs un string, cadena de car√†cters.
   mesures.push envia mesures dintre de l'array (conjunt de dades) que est√† composat per diversos objectes i cada objecte est√† format per latitud, longitud i ubicaci√≥.
   Aquests 3 arguments s√≥n els arguments utilitzats per .push, un m√®tode (aplicat sint√†xicament amb un punt endavant) que apliquem cap a un array.

   Funci√≥ an√≤nima: sense nom, executable, amb la intenci√≥ d'estalviar codi.
   Funci√≥ predefinida: amb nom, sense definir el nom dins del codi.

   const ubicacio = document.getElementById("ubicacioInput").value || `Punt ${mesures.length+1}`;
   La anterior l√≠nia indica que si el usuari no introdueix un nombre a la posici√≥, que el codi afegeixi un per defecte, que √©s "Punt" m√©s el nombre del punt m√©s 1.
   document.getElementById("ubicacioInput").value = "";
   La anterior l√≠nia esborra el text introduit a on es defineix el nom del punt.
   .textContent √©s una funci√≥ que altera el valor d'un string, substituint-lo amb un de nou.
   err.message √©s una funci√≥ que demana un missatge d'error predefinit.
   .message de 100 a 199 s√≥n informatius, de 200 a 299 s√≥n d'√®xit, de 300 a 399 de redirecci√≥, de 400 a 499 a d'error de client i de 500 a 599 d'error de servidor.  */ 

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const ubicacio = document.getElementById("ubicacioInput").value || `Punt ${mesures.length+1}`;
      mesures.push({lat, lon, ubicacio});
      document.getElementById("ubicacioInput").value = "";
      estat.textContent = "‚úÖ Mesura registrada!";
      actualitzaTaula();
      calculaDistancies();
      actualitzaMapa();
    },
    (err) => {
      estat.textContent = "‚ö†Ô∏è Error GPS: " + err.message;
    }, 
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
}

function actualitzaTaula() {
  const table = document.getElementById("mesuresTable");
  table.innerHTML = `
    <tr>
      <th>#</th>
      <th>Latitud</th>
      <th>Longitud</th>
      <th>Ubicaci√≥</th>
    </tr>`;

  mesures.forEach((m, i) => {
    const row = table.insertRow();
    row.insertCell(0).textContent = i+1;
    row.insertCell(1).textContent = m.lat.toFixed(6);
    row.insertCell(2).textContent = m.lon.toFixed(6);
    const cellUbic = row.insertCell(3);
    const input = document.createElement("input");
    input.value = m.ubicacio;
    input.oninput = () => {
      mesures[i].ubicacio = input.value;
      calculaDistancies();
      actualitzaMapa();
    };
    cellUbic.appendChild(input);
  });
}

function calculaDistancies() {
  const div = document.getElementById("distancies");
  if (mesures.length < 2) {
    div.innerHTML = "Afegiu almenys dues mesures per calcular dist√†ncies.";
    return;
  }

  let html = "";
  let totalPitag = 0;
  let totalHav = 0;
  for (let i = 0; i < mesures.length - 1; i++) {
    const p1 = mesures[i];
    const p2 = mesures[i+1];

    const dx = (p2.lon - p1.lon) * Math.cos((p1.lat + p2.lat)/2 * Math.PI/180) * 111.32;
    const dy = (p2.lat - p1.lat) * 110.574;
    const distPitag = Math.sqrt(dx*dx + dy*dy);
    totalPitag += distPitag;

    const R = 6371;
    const dLat = (p2.lat - p1.lat) * Math.PI/180;
    const dLon = (p2.lon - p1.lon) * Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distHav = R * c;
    totalHav += distHav;

    html += `<p><b>${i+1} ‚Üí ${i+2}:</b> ${p1.ubicacio} ‚Üí ${p2.ubicacio}<br>
      Pit√†gores: ${distPitag.toFixed(3)} km<br>
      Haversine: ${distHav.toFixed(3)} km</p>`;
  }

  html += `<p><b>Total:</b> Pit√†gores: ${totalPitag.toFixed(3)} km, Haversine: ${totalHav.toFixed(3)} km</p>`;
  div.innerHTML = html;
}

function actualitzaMapa() {
  const coords = mesures.map(m => [m.lat, m.lon]);
  polyline.setLatLngs(coords);
  if (coords.length > 0) map.setView(coords[coords.length-1], 15);
}

function exportCSV() {
  if (mesures.length === 0) return alert("No hi ha mesures per exportar.");
  let csv = "Latitud,Longitud,Ubicaci√≥\n";
  mesures.forEach(m => csv += `${m.lat},${m.lon},${m.ubicacio}\n`);
  const blob = new Blob([csv], {type: "text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "mesures.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function exportGPX() {
  if (mesures.length === 0) return alert("No hi ha mesures per exportar.");
  let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Mesurador">
<trk><name>Ruta GPS</name><trkseg>\n`;
  mesures.forEach(m => {
    gpx += `<trkpt lat="${m.lat}" lon="${m.lon}"><name>${m.ubicacio}</name></trkpt>\n`;
  });
  gpx += "</trkseg></trk></gpx>";
  const blob = new Blob([gpx], {type: "application/gpx+xml"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ruta.gpx";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
